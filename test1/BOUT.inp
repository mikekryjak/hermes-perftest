#

nout = 10 * 200
timestep = 95788 * 0.1

MZ = 1
NXPE = 1

####### NOTES
####### Target values: Te: 1450, Ti: 1745, Ne: 7.4e19
####### Target core diffusion: De = Di = 0.3, Chi_e = Chi_i = 0.45

####### CUSTOM INPUTS

# Power and particle input in core
power_mult = 0.3

electron_power = 0.76e6 * power_mult 
ion_power = 1e6 * power_mult
particle_source = 3e21 * 0.5   # 0.3

# Total volume of core ring and its shape
core_volume = 0.1806751354696394  # [m3]  from post-processing
core_source_shape = H(x) * H(0.05-x)

# Initial conditions
initial_te = 50 / hermes:Tnorm   # [eV]
initial_ti = 50 / hermes:Tnorm   # [eV]
initial_ne = 3e19 / hermes:Nnorm  # [m^-3]
initial_pe = initial_te * initial_ne
initial_pi = initial_ti * initial_ne

# Anomalous diffusion
coeff_D = 1
coeff_Chi = 3

[input]
error_on_unused_options = false    # Prevents crash from custom inputs

[mesh]
file = "g3e4-lores_widev2_nonortho_xpoint.nc"
nx = 40
MXG = 2

[mesh:paralleltransform]
type = shifted

[solver]
# mxstep = 1e9
# cvode_max_order = 3
# maxl = 5
# atol = 1e-8 * 1
# rtol = 1e-5 * 1
# use_precon = True
# diagnose = false

type = snes                      # Backward Euler steady-state solver
snes_type = newtonls             # Nonlinear solver
ksp_type = gmres                 # Linear solver: gmres, cg
max_nonlinear_iterations = 16    # default: 50
pc_type = hypre                  # Preconditioner type
pc_hypre_type = euclid           # Hypre preconditioner type: euclid, pilut, parasails, boomeramg, ams, ads
lag_jacobian = 250               # Iterations between jacobian recalculations. default: 50
atol = 1e-8                      # Absolute tolerance
rtol = 1e-5                      # Relative tolerance
stol = 1e-8
timestep = 0.1                   # Initial timestep

[hermes]
components = (d+, d, e,
              collisions, sheath_boundary_simple, recycling, 
              sound_speed,
              reactions,
              electron_force_balance)

Nnorm = 1e17  # Reference density [m^-3]
Bnorm = 1   # Reference magnetic field [T]
Tnorm = 300   # Reference temperature [eV]
qe = 1.60218e-19
Mp = 1.67262e-27
Cs0 = sqrt(qe * Tnorm / Mp)
Omega_ci = qe * Bnorm / Mp
rho_s0 = Cs0 / Omega_ci

[collisions]
diagnose = true
electron_electron = true
ion_ion = true
electron_ion = true
electron_neutral = false
ion_neutral = false
neutral_neutral = false

################################################################
# Ions

[d+]
type = evolve_density, evolve_momentum, evolve_pressure, anomalous_diffusion

AA = 2
charge = 1

thermal_conduction = true
kappa_limit_alpha = -1 # No flux limiter for ions

recycle_as = d
target_recycle = true
target_recycle_multiplier = 0.95
target_recycle_energy = 3.5

sol_recycle = true
sol_recycle_multiplier = 0.95
sol_recycle_energy = 3.5

pfr_recycle = true
pfr_recycle_multiplier = 0.95
pfr_recycle_energy = 3.5

target_fast_recycle_energy_factor = 0.48
target_fast_recycle_fraction = 0.80

anomalous_D = coeff_D
anomalous_chi = coeff_Chi
anomalous_nu = 0.2
diagnose = true

[Nd+]

function = initial_ne
bndry_sol = decaylength(0.03 / hermes:rho_s0)
bndry_pf = decaylength(0.03 / hermes:rho_s0)
bndry_all = neumann   # All boundaries neumann
source = particle_source / core_volume * core_source_shape  # s^-1 m^-3
source_only_in_core = true

[Pd+]

function = initial_pi
bndry_sol = decaylength(0.03 / hermes:rho_s0)
bndry_pf = decaylength(0.03 / hermes:rho_s0)
bndry_all = neumann   # All boundaries neumann
source = ion_power * 2/3 / core_volume * core_source_shape    # Pa s^-1 m^-3
source_only_in_core = true

################################################################
# Neutrals

[d]
type = neutral_mixed, neutral_boundary

precondition = false
neutral_conduction = true
neutral_viscosity = true

flux_limit = true
AA = 2
diagnose = true
output_ddt = true

neutral_boundary_sol = true
neutral_boundary_pfr = true
neutral_boundary_upper_y = true
neutral_boundary_lower_y = true

target_energy_refl_factor = 0.70
sol_energy_refl_factor = 0.67
pfr_energy_refl_factor = 0.67

target_fast_refl_fraction = 0.80
sol_fast_refl_fraction = 0.70
pfr_fast_refl_fraction = 0.70

[Pd]
function = initial_pe / 1000
bndry_sol = neumann  # This prevents advection of density or energy out of the SOL
bndry_core = free_o3  # This allows density and energy advection out of core
bndry_all = neumann

[Nd]
function = initial_ne / 1000
bndry_sol = neumann 
bndry_core = free_o3  # This allows density and energy advection out of core
bndry_all = neumann

[Td]
bndry_sol = neumann  
bndry_all = neumann

################################################################
# Electrons

[e]
# Set electron density from quasineutrality,
# and parallel flow from ion flow, assuming no currents
type = quasineutral, evolve_pressure, zero_current, anomalous_diffusion

AA = 1/1836
charge = -1
thermal_conduction = true
kappa_limit_alpha = 0.2

anomalous_D = coeff_D
anomalous_chi = coeff_Chi
anomalous_nu = 0.2
diagnose = true

[Pe]
function = initial_pi
bndry_sol = decaylength(0.03 / hermes:rho_s0)
bndry_pfr = decaylength(0.03 / hermes:rho_s0)
bndry_all = neumann   # All other boundaries low density

source = electron_power * 2/3 / core_volume * core_source_shape    # Pa s^-1 m^-3
source_only_in_core = true

################################################################
[sheath_boundary_simple]
gamma_i = 2.5
gamma_e = 4.5

[recycling]

species = d+

[reactions]

diagnose = true

type = (
        d + e -> d+ + 2e,     # Deuterium ionisation
        d+ + e -> d,          # Deuterium recombination
        d + d+ -> d+ + d,     # Charge exchange
       )

